<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد التغذية الشخصي</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, Timestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope for use in the main script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, Timestamp, updateDoc
        };
    </script>

    <style>
        /* Custom font for the application */
        body {
            font-family: 'Cairo', sans-serif;
        }
        /* Custom styles for better UX */
        .prose ul { list-style-type: disc; padding-right: 1.5rem; }
        .prose li { margin-bottom: 0.5rem; }
        .prose strong { font-weight: 700; }
        .hidden { display: none; }
        .dynamic-tip-enter-active { transition: opacity 0.5s ease; }
        .dynamic-tip-enter { opacity: 0; }
        
        /* CSS for the original waving Sudanese flag */
        .flag-container {
            width: 40px;
            height: 20px;
            position: absolute;
            top: 20px;
            right: 0;
            animation: waving 2s ease-in-out infinite;
        }
        
        .flag-stripe {
            height: 33.33%;
            width: 100%;
            position: relative;
        }

        .flag-stripe.red { background-color: #d11c24; }
        .flag-stripe.white { background-color: #ffffff; }
        .flag-stripe.black { background-color: #000000; }

        .flag-triangle {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 10px 10px 20px;
            border-color: transparent transparent transparent #00723a;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        @keyframes waving {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body class="bg-white text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Main container with background styles -->
    <div class="bg-gradient-to-br from-green-50 to-teal-100 dark:bg-none min-h-screen p-4 sm:p-8 flex flex-col items-center">

        <!-- Custom Notification -->
        <div id="notification" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 ease-in-out transform">
            <span id="notification-message"></span>
        </div>
        
        <!-- Loading overlay for initial data fetch -->
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl dark:bg-gray-800">
                <svg class="animate-spin h-10 w-10 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-gray-700 font-semibold dark:text-gray-200">جاري تحميل البيانات...</p>
            </div>
        </div>

        <!-- Header -->
        <header class="w-full max-w-4xl text-center mb-8 relative">
            <!-- Sudanese Flag -->
            <div class="flag-container">
                <div class="flag-stripe red"></div>
                <div class="flag-stripe white"></div>
                <div class="flag-stripe black"></div>
                <div class="flag-triangle"></div>
            </div>
            
            <h1 class="text-4xl sm:text-5xl font-extrabold text-green-700 drop-shadow-lg mb-2 dark:text-green-400">
                وصفتي
            </h1>
            <p class="text-xl sm:text-2xl text-teal-600 dark:text-teal-400">مطبخك الذكي</p>
            
            <!-- Header buttons container -->
            <div class="absolute top-0 left-0 flex space-x-2 space-x-reverse">
                <!-- Theme toggle button -->
                <button id="theme-toggle" class="p-2 rounded-full text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-700 transition-colors duration-300">
                    <!-- Initial icon, will be updated by JS -->
                    <i data-lucide="moon" class="w-6 h-6 theme-icon"></i>
                </button>
                <!-- User ID toggle button -->
                <button id="toggle-user-info-btn" class="p-2 rounded-full text-gray-800 dark:text-gray-100 bg-gray-200 dark:bg-gray-700 transition-colors duration-300">
                    <i data-lucide="eye-off" class="w-6 h-6 user-info-icon"></i>
                </button>
            </div>

            <!-- User ID Info -->
            <div class="absolute top-0 right-0 flex flex-col items-end p-2 text-right">
                <div id="user-info" class="text-sm text-gray-500 dark:text-gray-400 hidden">
                    <!-- User ID will be displayed here -->
                </div>
            </div>
        </header>

        <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Meal Planner Section -->
            <section class="bg-white p-6 rounded-2xl shadow-xl border border-green-200 col-span-1 md:col-span-2 dark:bg-gray-800 dark:border-green-700">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h2 class="flex items-center text-2xl font-bold text-green-800 dark:text-green-300">
                            <i data-lucide="chef-hat" class="w-7 h-7 ml-2 text-green-600 dark:text-green-400"></i>
                            خطط وجباتك
                        </h2>
                        <!-- Display for remaining meal plans -->
                        <div id="meal-plan-count" class="text-sm font-semibold text-green-600 dark:text-green-400 mr-2">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>
                     <!-- New: API Usage Info -->
                     <div id="api-usage-info" class="text-sm font-semibold text-green-700 dark:text-green-300">
                        <!-- Usage count will be displayed here -->
                     </div>
                </div>
                <div class="mb-4">
                    <!-- Cuisine and Meal Type Selection -->
                    <div class="mb-4 p-4 bg-green-50 rounded-lg border border-green-200 flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4 sm:space-x-reverse dark:bg-gray-700 dark:border-green-600">
                        <span class="font-semibold text-green-800 text-lg sm:ml-4 dark:text-green-200">اختر المطبخ:</span>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="cuisine" value="sudanese" checked class="form-radio h-5 w-5 text-green-600 dark:text-green-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">سودانية</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="cuisine" value="egyptian" class="form-radio h-5 w-5 text-green-600 dark:text-green-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">مصرية</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="cuisine" value="turkish" class="form-radio h-5 w-5 text-green-600 dark:text-green-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">تركية</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="cuisine" value="arabic" class="form-radio h-5 w-5 text-green-600 dark:text-green-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">عربية</span>
                        </label>
                    </div>
                    <div class="mb-4 p-4 bg-green-50 rounded-lg border border-green-200 flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4 sm:space-x-reverse dark:bg-gray-700 dark:border-green-600">
                        <span class="font-semibold text-green-800 text-lg sm:ml-4 dark:text-green-200">اختر نوع الوجبة:</span>
                        <select id="meal-type" class="p-2 pr-8 rounded-lg border border-green-300 focus:outline-none focus:ring-2 focus:ring-green-400 text-right bg-white dark:bg-gray-800 dark:text-gray-100 dark:border-green-600">
                            <option value="وجبة">وجبة عادية</option>
                            <option value="فطور">فطور</option>
                            <option value="غداء">غداء</option>
                            <option value="عشاء">عشاء</option>
                            <option value="وجبة عائلية">وجبة عائلية</option>
                            <option value="وجبة رومانسية">وجبة رومانسية</option>
                        </select>
                    </div>
                    
                    <!-- Advanced Filters Section -->
                    <h3 class="text-xl font-semibold text-orange-700 mb-3 border-b pb-2 border-orange-200 mt-6 dark:text-orange-400 dark:border-orange-600">
                        فلتر التفضيلات الغذائية:
                    </h3>
                    <div class="mb-4 p-4 bg-orange-50 rounded-lg border border-orange-200 flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4 sm:space-x-reverse dark:bg-gray-700 dark:border-orange-600">
                        <span class="font-semibold text-orange-800 text-lg sm:ml-4 dark:text-orange-200">تفضيلاتك:</span>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="dietary-preference" value="vegetarian" class="form-checkbox h-5 w-5 text-orange-600 rounded dark:text-orange-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">نباتي</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="dietary-preference" value="vegan" class="form-checkbox h-5 w-5 text-orange-600 rounded dark:text-orange-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">فيجن</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="dietary-preference" value="gluten-free" class="form-checkbox h-5 w-5 text-orange-600 rounded dark:text-orange-400">
                            <span class="mr-2 text-gray-700 dark:text-gray-300">خالي من الغلوتين</span>
                        </label>
                    </div>

                    <!-- AI Meal Suggestion from User Ingredients -->
                    <h3 class="text-xl font-semibold text-purple-700 mb-3 border-b pb-2 border-purple-200 mt-6 dark:text-purple-400 dark:border-purple-600">
                        ✨ اقتراح وجبة من مكوناتك:
                    </h3>
                    <textarea id="user-ingredients" placeholder="أضف المكونات المتوفرة لديك (افصل بينها بفاصلة، مثال: طماطم، بصل، دجاج)" class="w-full p-3 mb-3 border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 resize-y text-right bg-white dark:bg-gray-700 dark:text-gray-100 dark:border-purple-600" rows="3"></textarea>
                    
                    <!-- New: Image Upload Section -->
                    <div class="mb-4">
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                        <button id="image-search-btn" data-icon="camera" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center mb-3">
                            <span class="icon-container w-5 h-5 ml-2"><i data-lucide="camera" class="w-5 h-5"></i></span>
                            <span class="button-text">بحث بالصورة (مكونات الثلاجة)</span>
                        </button>
                    </div>
                    
                    <button id="suggest-from-ingredients-btn" data-icon="sparkles" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center mb-3">
                        <span class="icon-container w-5 h-5 ml-2"><i data-lucide="sparkles" class="w-5 h-5"></i></span>
                        <span class="button-text">✨ اقتراح وجبة من مكوناتي</span>
                    </button>

                    <!-- General AI Meal Suggestion Button -->
                    <h3 class="text-xl font-semibold text-indigo-700 mb-3 border-b pb-2 border-indigo-200 mt-6 dark:text-indigo-400 dark:border-indigo-600">
                        ✨ اختر وجبة عشوائية من الذكاء الاصطناعي:
                    </h3>
                    <button id="suggest-general-btn" data-icon="sparkles" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center mb-6">
                        <span class="icon-container w-5 h-5 ml-2"><i data-lucide="sparkles" class="w-5 h-5"></i></span>
                        <span class="button-text">✨ اختر وجبة (بالذكاء الاصطناعي)</span>
                    </button>

                    <!-- Display Suggested Meal -->
                    <div id="suggested-meal-container" class="hidden bg-purple-50 p-4 rounded-lg shadow-md border border-purple-200 mb-6 dark:bg-gray-700 dark:border-purple-600">
                        <!-- Content will be injected by JS -->
                    </div>

                    <!-- Analyze Ingredients Button -->
                    <button id="analyze-ingredients-btn" data-icon="sliders-horizontal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center">
                        <span class="icon-container w-5 h-5 ml-2"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i></span>
                        <span class="button-text">✨ تحليل المكونات (بالذكاء الاصطناعي)</span>
                    </button>
                </div>

                <!-- Display Meal Plans -->
                <h3 class="text-xl font-semibold text-green-700 mb-3 border-b pb-2 border-green-200 mt-6 dark:text-green-400 dark:border-green-600">
                    وجباتك المخطط لها:
                </h3>
                <ul id="meal-plans-list" class="space-y-3">
                    <p id="no-meals-message" class="text-gray-600 text-center py-4 dark:text-gray-400">لم تقم بإضافة أي وجبات بعد.</p>
                    <!-- Meal items will be injected by JS -->
                </ul>
            </section>

            <!-- Right Column: Grocery List & Nutrition Tips -->
            <div class="flex flex-col gap-6">
                <!-- Grocery List Section -->
                <section class="bg-white p-6 rounded-2xl shadow-xl border border-teal-200 dark:bg-gray-800 dark:border-teal-700">
                    <h2 class="flex items-center text-2xl font-bold text-teal-800 mb-4 dark:text-teal-300">
                        <i data-lucide="shopping-bag" class="w-7 h-7 ml-2 text-teal-600 dark:text-teal-400"></i>
                        قائمة التسوق
                    </h2>
                    <div id="grocery-list" class="space-y-4">
                         <p id="no-groceries-message" class="text-gray-600 text-center py-4 dark:text-gray-400">قائمة التسوق فارغة. أضف وجبات لتعبئتها!</p>
                        <!-- Grocery items will be injected by JS -->
                    </div>
                    <button id="clear-grocery-btn" class="w-full mt-6 bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                        مسح قائمة التسوق
                    </button>
                </section>

                <!-- Dynamic Nutrition Tips/Analysis Section -->
                <section class="bg-white p-6 rounded-2xl shadow-xl border border-orange-200 dark:bg-gray-800 dark:border-orange-700">
                    <div id="nutrition-tips-header" class="relative">
                         <h2 class="flex items-center text-2xl font-bold text-orange-800 mb-4 dark:text-orange-300">
                            <i data-lucide="lightbulb" class="w-7 h-7 ml-2 text-orange-600 dark:text-orange-400"></i>
                            نصائح غذائية عامة
                        </h2>
                    </div>
                    <div id="nutrition-tips-content" class="space-y-4">
                        <!-- Tips will be injected by JS -->
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="w-full max-w-4xl text-center mt-8 text-gray-600 text-sm dark:text-gray-400">
            <p>© <span id="year"></span> وصفتي. جميع الحقوق محفوظة.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            let db, auth;
            let userId = null;
            let isAuthReady = false;
            let loadingOverlay = document.getElementById('loading-overlay');
            const userInfoElement = document.getElementById('user-info');
            const apiUsageInfoElement = document.getElementById('api-usage-info');
            
            // API URL for the single Cloudflare Worker
            const workerUrl = "https://workers-playground-autumn-pond-05c1.tito9py.workers.dev";
            
            // Check if Firebase config is available before initializing
            if (Object.keys(firebaseConfig).length > 0) {
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(firebaseApp);
                auth = firebase.getAuth(firebaseApp);

                // Sign in the user
                const signInUser = async () => {
                    try {
                        if (initialAuthToken) {
                            await firebase.signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await firebase.signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        showCustomNotification("فشل تسجيل الدخول. بعض الميزات قد لا تعمل.");
                        isAuthReady = true;
                        loadingOverlay.classList.add('hidden');
                    }
                };
                
                // Listen for auth state changes to get the user ID
                firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoElement.textContent = `المستخدم: ${userId}`;
                        await loadUserData();
                        await loadUsageData(); // Load usage data after auth is ready
                        isAuthReady = true;
                    } else {
                        userId = null;
                        userInfoElement.textContent = `المستخدم: (غير مسجل)`;
                        isAuthReady = true;
                        loadingOverlay.classList.add('hidden');
                    }
                    loadingOverlay.classList.add('hidden');
                });

                signInUser();
            } else {
                console.error("Firebase config is missing. Data persistence will be disabled.");
                showCustomNotification("فشل تهيئة قاعدة البيانات. لن يتم حفظ البيانات.");
                isAuthReady = true;
                loadingOverlay.classList.add('hidden');
            }


            // --- STATE MANAGEMENT ---
            let mealPlans = [];
            let suggestedMeal = null;
            let isLoadingRecipe = false;
            let isAnalyzingIngredients = false;
            let isAnalyzingImage = false;
            let currentTipIndex = 0;
            let tipsInterval = null;
            let dietaryPreferences = [];
            let usageCount = 0;
            let lastUsageDate = null;
            
            // --- CONSTANTS ---
            const MAX_MEAL_PLANS = 10;
            const MAX_DAILY_REQUESTS = 10; // New: Daily request limit
            
            // --- DOM ELEMENT REFERENCES ---
            const userIngredientsInput = document.getElementById('user-ingredients');
            const suggestFromIngredientsBtn = document.getElementById('suggest-from-ingredients-btn');
            const suggestGeneralBtn = document.getElementById('suggest-general-btn');
            const analyzeIngredientsBtn = document.getElementById('analyze-ingredients-btn');
            const suggestedMealContainer = document.getElementById('suggested-meal-container');
            const mealPlansList = document.getElementById('meal-plans-list');
            const noMealsMessage = document.getElementById('no-meals-message');
            const groceryList = document.getElementById('grocery-list');
            const noGroceriesMessage = document.getElementById('no-groceries-message');
            const clearGroceryBtn = document.getElementById('clear-grocery-btn');
            const nutritionTipsHeader = document.getElementById('nutrition-tips-header');
            const nutritionTipsContent = document.getElementById('nutrition-tips-content');
            const mealTypeSelect = document.getElementById('meal-type');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const toggleUserInfoBtn = document.getElementById('toggle-user-info-btn');
            const htmlElement = document.documentElement;
            const themeIconElement = themeToggleBtn.querySelector('.theme-icon');
            const userInfoIconElement = toggleUserInfoBtn.querySelector('.user-info-icon');
            const dietaryPreferenceCheckboxes = document.querySelectorAll('input[name="dietary-preference"]');
            const mealPlanCountElement = document.getElementById('meal-plan-count');

            // New Image Elements
            const imageUploadInput = document.getElementById('image-upload');
            const imageSearchBtn = document.getElementById('image-search-btn');

            document.getElementById('year').textContent = new Date().getFullYear();

            // --- INITIAL STATIC DATA ---
            const staticNutritionTips = [
                "اشرب كمية كافية من الماء يوميًا للحفاظ على ترطيب الجسم.",
                "ركز على تناول الخضروات والفواكه الطازجة في كل وجبة.",
                "استبدل الحبوب المكررة بالحبوب الكاملة مثل الأرز البني والخبز الأسمر.",
                "قلل من تناول الأطعمة المصنعة والسكريات المضافة.",
                "اختر مصادر البروتين الصحية مثل الدجاج، السمك، البقوليات، والبيض.",
                "تناول وجبات صغيرة ومتعددة على مدار اليوم بدلاً من وجبات كبيرة قليلة.",
                "استخدم الزيوت الصحية مثل زيت الزيتون وزيت عباد الشمس بكميات معتدلة.",
                "تجنب الإفراط في تناول الملح والأطعمة عالية الصوديوم."
            ];

            // --- RENDER FUNCTIONS ---
            
            // Renders the list of planned meals and updates the counter
            const renderMealPlans = () => {
                mealPlansList.innerHTML = '';
                
                mealPlanCountElement.textContent = `(${mealPlans.length} / ${MAX_MEAL_PLANS})`;
                
                if (mealPlans.length === 0) {
                    mealPlansList.appendChild(noMealsMessage);
                    noMealsMessage.classList.remove('hidden');
                } else {
                    noMealsMessage.classList.add('hidden');
                    mealPlans.forEach(meal => {
                        const li = document.createElement('li');
                        li.className = "bg-green-50 p-4 rounded-lg shadow-sm flex flex-col items-start border border-green-100 dark:bg-gray-700 dark:border-green-600";
                        li.innerHTML = `
                            <div class="flex justify-between items-center w-full mb-2">
                                <strong class="text-green-800 block text-lg dark:text-green-300">${meal.recipeName}</strong>
                                <button data-id="${meal.id}" class="delete-meal-btn text-red-500 hover:text-red-700 transition duration-200" title="حذف الوجبة">
                                    <i data-lucide="x-circle" class="w-6 h-6 pointer-events-none"></i>
                                </button>
                            </div>
                            <span class="text-gray-700 text-sm mb-2 dark:text-gray-300">
                                <span class="font-semibold">المكونات:</span> ${meal.ingredients.join('، ')}
                            </span>
                            <div class="flex items-start text-gray-700 text-sm mb-2 dark:text-gray-300">
                                <i data-lucide="book-open" class="w-5 h-5 ml-2 mt-1 text-green-600 dark:text-green-400 flex-shrink-0"></i>
                                <div><span class="font-semibold">طريقة التحضير:</span> ${meal.preparation}</div>
                            </div>
                            ${meal.youtubeSearchQuery ? `
                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(meal.youtubeSearchQuery)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-red-600 hover:text-red-800 transition duration-200 font-semibold text-sm mt-1" title="شاهد فيديو التحضير على يوتيوب">
                                <i data-lucide="youtube" class="w-5 h-5 ml-2"></i>
                                شاهد طريقة التحضير على يوتيوب
                            </a>` : ''}
                        `;
                        mealPlansList.appendChild(li);
                    });
                }
                renderGroceryList();
                lucide.createIcons();
            };

            // Renders the grocery list
            const renderGroceryList = () => {
                groceryList.innerHTML = '';
                if (mealPlans.length === 0) {
                    groceryList.appendChild(noGroceriesMessage);
                    noGroceriesMessage.classList.remove('hidden');
                } else {
                    noGroceriesMessage.classList.add('hidden');
                    mealPlans.forEach((meal, index) => {
                        const mealContainer = document.createElement('div');
                        mealContainer.className = "bg-teal-50 p-4 rounded-lg border border-teal-100 dark:bg-gray-700 dark:border-teal-600";
                        
                        const mealTitle = document.createElement('h4');
                        mealTitle.className = "text-lg font-semibold text-teal-800 mb-2 dark:text-teal-300";
                        mealTitle.textContent = meal.recipeName;
                        mealContainer.appendChild(mealTitle);

                        const ingredientsList = document.createElement('ul');
                        ingredientsList.className = "list-disc list-inside space-y-1 pr-4 text-gray-700 dark:text-gray-300";
                        meal.ingredients.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item;
                            ingredientsList.appendChild(li);
                        });
                        mealContainer.appendChild(ingredientsList);
                        groceryList.appendChild(mealContainer);

                        if (index < mealPlans.length - 1) {
                            const separator = document.createElement('div');
                            separator.className = "my-4 border-t-2 border-teal-200 dark:border-teal-600";
                            groceryList.appendChild(separator);
                        }
                    });
                }
            };
            
            // Renders a single dynamic nutrition tip and starts the interval
            const renderStaticTips = () => {
                if (tipsInterval) {
                    clearInterval(tipsInterval);
                }

                nutritionTipsHeader.innerHTML = `
                    <h2 class="flex items-center text-2xl font-bold text-orange-800 mb-4 dark:text-orange-300">
                        <i data-lucide="lightbulb" class="w-7 h-7 ml-2 text-orange-600 dark:text-orange-400"></i>
                        نصائح غذائية عامة
                    </h2>`;
                
                const displayTip = () => {
                    const tip = staticNutritionTips[currentTipIndex];
                    nutritionTipsContent.innerHTML = `
                        <div class="bg-orange-50 p-4 rounded-lg shadow-sm flex items-start border border-orange-100 dynamic-tip-enter dark:bg-gray-700 dark:border-orange-600">
                            <span class="w-3 h-3 bg-orange-500 rounded-full mt-1 ml-3 flex-shrink-0"></span>
                            <p class="text-gray-700 dark:text-gray-300">${tip}</p>
                        </div>
                    `;
                    setTimeout(() => {
                        const newTipElement = nutritionTipsContent.querySelector('.dynamic-tip-enter');
                        if (newTipElement) {
                            newTipElement.classList.remove('dynamic-tip-enter');
                            newTipElement.classList.add('dynamic-tip-enter-active');
                        }
                    }, 10);
                    
                    currentTipIndex = (currentTipIndex + 1) % staticNutritionTips.length;
                };

                displayTip();
                tipsInterval = setInterval(displayTip, 5000);
                lucide.createIcons();
            };
            
            // Renders the dynamic nutrition analysis
            const renderDynamicTips = (analysisText) => {
                if (tipsInterval) {
                    clearInterval(tipsInterval);
                }

                 nutritionTipsHeader.innerHTML = `
                    <h2 class="flex items-center text-2xl font-bold text-orange-800 mb-4 dark:text-orange-300">
                        <i data-lucide="sliders-horizontal" class="w-7 h-7 ml-2 text-blue-600 dark:text-blue-400"></i>
                        نصائح غذائية مخصصة وتحليل المكونات
                    </h2>
                    <button id="clear-analysis-btn" class="absolute top-0 left-0 p-1 text-gray-500 hover:text-red-500 transition-colors duration-200 rounded-full" title="مسح التحليل">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    `;
                const formattedText = analysisText.split('\n').map(line => {
                    if (line.trim().startsWith('*')) {
                        return `<li class="flex items-start"><span class="ml-2 text-orange-500">•</span>${line.substring(1).trim()}</li>`;
                    }
                    return `<p>${line.trim()}</p>`;
                }).join('');
                nutritionTipsContent.innerHTML = `<div class="prose max-w-none text-gray-700 dark:text-gray-300"><ul class="space-y-2">${formattedText}</ul></div>`;
                lucide.createIcons();
            };
            
            // --- HELPER FUNCTIONS ---
            const showCustomNotification = (message) => {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                
                if (!notification || !notificationMessage) {
                    console.error("Notification element or message element not found.");
                    return;
                }
                
                notificationMessage.textContent = message;
                notification.classList.remove('hidden');
                notification.classList.add('opacity-100', 'scale-100');
                setTimeout(() => {
                    notification.classList.remove('opacity-100', 'scale-100');
                    notification.classList.add('hidden');
                }, 3000);
            };

            const toggleLoading = (button, isLoading, originalText, iconName) => {
                const iconContainer = button.querySelector('.icon-container');
                const textSpan = button.querySelector('.button-text');
                
                if (!iconContainer || !textSpan) {
                    console.error("Button structure is incorrect. Missing .icon-container or .button-text");
                    return;
                }

                if (isLoading) {
                    button.disabled = true;
                    iconContainer.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    textSpan.textContent = 'جاري...';
                } else {
                    button.disabled = false;
                    const icon = iconName || button.dataset.icon || 'sparkles';
                    iconContainer.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
                    lucide.createIcons();
                    textSpan.textContent = originalText;
                }
            };
            
            const toggleDarkMode = () => {
                if (htmlElement.classList.contains('dark')) {
                    htmlElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    themeIconElement.setAttribute('data-lucide', 'moon');
                } else {
                    htmlElement.classList.add('dark');
                    localStorage.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    themeIconElement.setAttribute('data-lucide', 'sun');
                }
                lucide.createIcons();
            };
            
            const toggleUserInfo = () => {
                if (userInfoElement.classList.contains('hidden')) {
                    userInfoElement.classList.remove('hidden');
                    userInfoIconElement.setAttribute('data-lucide', 'eye');
                } else {
                    userInfoElement.classList.add('hidden');
                    userInfoIconElement.setAttribute('data-lucide', 'eye-off');
                }
                lucide.createIcons();
            };

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                htmlElement.classList.add('dark');
                themeIconElement.setAttribute('data-lucide', 'sun');
            } else {
                htmlElement.classList.remove('dark');
                themeIconElement.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();

            // --- FIREBASE DATA MANAGEMENT ---
            
            const loadUserData = async () => {
                if (!db || !userId) return;

                try {
                    const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/preferences/user-data`);
                    const docSnap = await firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        if (data.mealPlans) {
                            mealPlans = JSON.parse(data.mealPlans);
                            renderMealPlans();
                        }
                        
                        if (data.dietaryPreferences) {
                            dietaryPreferences = data.dietaryPreferences;
                            dietaryPreferenceCheckboxes.forEach(checkbox => {
                                checkbox.checked = dietaryPreferences.includes(checkbox.value);
                            });
                        }
                        showCustomNotification("تم تحميل بياناتك الشخصية بنجاح!");
                    } else {
                        console.log("No personal data found, starting fresh.");
                    }
                } catch (e) {
                    console.error("Error loading user data:", e);
                    showCustomNotification("فشل تحميل بياناتك. يرجى المحاولة مرة أخرى.");
                }
            };

            const saveUserData = async () => {
                if (!db || !userId) return;
                
                if (mealPlans.length === 0 && dietaryPreferences.length === 0) {
                    return;
                }

                try {
                    const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/preferences/user-data`);
                    const serializedMealPlans = JSON.stringify(mealPlans);

                    await firebase.setDoc(docRef, {
                        mealPlans: serializedMealPlans,
                        dietaryPreferences: dietaryPreferences,
                        lastUpdated: firebase.Timestamp.now()
                    }, { merge: true });

                    console.log("User data saved successfully!");
                } catch (e) {
                    console.error("Error saving user data:", e);
                    showCustomNotification("فشل حفظ البيانات. يرجى المحاولة مرة أخرى.");
                }
            };
            
            // New: Load and manage API usage data
            const loadUsageData = async () => {
                if (!db || !userId) return;
                
                try {
                    const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/usage/api`);
                    const docSnap = await firebase.getDoc(docRef);

                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const lastUsedTimestamp = data.lastUsed?.toDate();
                        
                        // Check if it's a new day, reset if so
                        if (lastUsedTimestamp && lastUsedTimestamp < today) {
                            console.log("New day detected, resetting usage count.");
                            usageCount = 0;
                            lastUsageDate = firebase.Timestamp.now();
                            await saveUsageData();
                        } else {
                            usageCount = data.count || 0;
                            lastUsageDate = data.lastUsed || null;
                        }
                    } else {
                        console.log("No usage data found, starting fresh.");
                        usageCount = 0;
                        lastUsageDate = firebase.Timestamp.now();
                        await saveUsageData();
                    }
                    renderUsageCount();

                } catch (e) {
                    console.error("Error loading usage data:", e);
                    showCustomNotification("فشل تحميل بيانات الاستخدام.");
                }
            };

            // New: Save API usage data
            const saveUsageData = async () => {
                if (!db || !userId) return;

                try {
                    const docRef = firebase.doc(db, `artifacts/${appId}/users/${userId}/usage/api`);
                    await firebase.setDoc(docRef, {
                        count: usageCount,
                        lastUsed: lastUsageDate
                    }, { merge: true });
                } catch (e) {
                    console.error("Error saving usage data:", e);
                }
            };

            // New: Check and increment usage before making a request
            const checkAndIncrementUsage = async () => {
                if (!isAuthReady) {
                    showCustomNotification("جاري تهيئة النظام، يرجى المحاولة بعد لحظات.");
                    return false;
                }
                
                // Ensure the usage count is up to date
                await loadUsageData();

                if (usageCount >= MAX_DAILY_REQUESTS) {
                    showCustomNotification(`لقد وصلت إلى الحد الأقصى للطلبات اليومية (${MAX_DAILY_REQUESTS} طلبات).`);
                    return false;
                }

                usageCount++;
                lastUsageDate = firebase.Timestamp.now();
                await saveUsageData();
                renderUsageCount();
                return true;
            };

            // New: Render API usage count
            const renderUsageCount = () => {
                const remaining = MAX_DAILY_REQUESTS - usageCount;
                apiUsageInfoElement.textContent = `الطلبات المتبقية: ${remaining}`;
            };


            // --- CORE LOGIC FUNCTIONS ---
            
            const addSuggestedMealToPlan = () => {
                if (suggestedMeal) {
                    if (mealPlans.length >= MAX_MEAL_PLANS) {
                        showCustomNotification(`لا يمكن إضافة المزيد من الوجبات. الحد الأقصى هو ${MAX_MEAL_PLANS}.`);
                        return;
                    }

                    mealPlans.push({ id: Date.now(), ...suggestedMeal });
                    renderMealPlans();
                    saveUserData();
                    showCustomNotification("تم إضافة الوجبة المقترحة وتحديث قائمة التسوق بنجاح!");
                    suggestedMeal = null;
                    suggestedMealContainer.innerHTML = '';
                    suggestedMealContainer.classList.add('hidden');
                    userIngredientsInput.value = '';
                } else {
                    showCustomNotification("لا توجد وجبة مقترحة لإضافتها.");
                }
            };

            const clearSuggestedMeal = () => {
                suggestedMeal = null;
                suggestedMealContainer.innerHTML = '';
                suggestedMealContainer.classList.add('hidden');
                userIngredientsInput.value = '';
                showCustomNotification("تم مسح الاقتراح.");
            };
            
            const deleteMealPlan = (id) => {
                mealPlans = mealPlans.filter(meal => meal.id !== id);
                renderMealPlans();
                saveUserData();
                showCustomNotification("تم حذف الوجبة وتحديث قائمة التسوق.");
            };
            
            // --- API CALLS (GEMINI via Cloudflare Worker) ---
            const callGeminiAPI = async (payload) => {
                try {
                    const response = await fetch(workerUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error(`API call failed:`, error);
                    showCustomNotification("حدث خطأ في الاتصال بالذكاء الاصطناعي. يرجى المحاولة مرة أخرى.");
                    return null;
                }
            };

            const generateRecipe = async (isGeneral) => {
                if (isLoadingRecipe || isAnalyzingIngredients || isAnalyzingImage) return;

                const ingredients = userIngredientsInput.value.trim();
                if (!isGeneral && !ingredients) {
                    showCustomNotification("الرجاء إدخال المكونات المتوفرة لديك أولاً.");
                    return;
                }
                
                // New: Check API usage before proceeding
                const canProceed = await checkAndIncrementUsage();
                if (!canProceed) return;

                isLoadingRecipe = true;
                const button = isGeneral ? suggestGeneralBtn : suggestFromIngredientsBtn;
                const originalText = button.querySelector('.button-text').textContent;
                toggleLoading(button, true, originalText);
                
                renderStaticTips();
                suggestedMealContainer.classList.add('hidden');
                suggestedMeal = null;

                const selectedCuisine = document.querySelector('input[name="cuisine"]:checked').value;
                const selectedMealType = mealTypeSelect.value;
                
                let cuisineText;
                switch (selectedCuisine) {
                    case 'sudanese': cuisineText = 'سودانية'; break;
                    case 'egyptian': cuisineText = 'مصرية'; break;
                    case 'turkish': cuisineText = 'تركية'; break;
                    case 'arabic': cuisineText = 'عربية'; break;
                    default: cuisineText = 'عربية'; break;
                }
                
                const preferencesText = dietaryPreferences.length > 0
                    ? `، مع مراعاة التفضيلات الغذائية التالية: ${dietaryPreferences.map(p => {
                        switch(p) {
                            case 'vegetarian': return 'نباتي';
                            case 'vegan': return 'فيجن';
                            case 'gluten-free': return 'خالي من الغلوتين';
                            default: return '';
                        }
                    }).filter(Boolean).join(' و ')}`
                    : '';

                const uniqueId = Math.random();
                
                const prompt = isGeneral 
                    ? `اقترح ${selectedMealType} ${cuisineText}${preferencesText}. قدم اسم الوصفة، قائمة المكونات، وطريقة التحضير. يجب أن تتضمن عبارة بحث لـ YouTube باللغة العربية. ${uniqueId}`
                    : `بناءً على المكونات التالية: "${ingredients}". اقترح ${selectedMealType} ${cuisineText}${preferencesText} يمكن تحضيرها. قدم اسم الوصفة، قائمة المكونات، وطريقة التحضير. يجب أن تتضمن عبارة بحث لـ YouTube باللغة العربية. ${uniqueId}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "recipeName": { "type": "STRING" },
                                "ingredients": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "preparation": { "type": "STRING" },
                                "youtubeSearchQuery": { "type": "STRING" }
                            },
                            "propertyOrdering": ["recipeName", "ingredients", "preparation", "youtubeSearchQuery"]
                        }
                    }
                };

                const result = await callGeminiAPI(payload);

                if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    try {
                        suggestedMeal = JSON.parse(result.candidates[0].content.parts[0].text);
                        suggestedMealContainer.innerHTML = `
                            <h4 class="text-xl font-semibold text-purple-800 mb-2 dark:text-purple-300">${suggestedMeal.recipeName}</h4>
                            <p class="text-gray-700 text-sm mb-2 dark:text-gray-300"><span class="font-semibold">المكونات:</span> ${suggestedMeal.ingredients.join('، ')}</p>
                            <p class="text-gray-700 text-sm mb-2 dark:text-gray-300"><span class="font-semibold">طريقة التحضير:</span> ${suggestedMeal.preparation}</p>
                            ${suggestedMeal.youtubeSearchQuery ? `<a href="https://www.youtube.com/results?search_query=${encodeURIComponent(suggestedMeal.youtubeSearchQuery)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-red-600 hover:text-red-800 transition duration-200 font-semibold text-sm mt-1 dark:text-red-400" title="شاهد فيديو التحضير على يوتيوب">
                                <i data-lucide="youtube" class="w-5 h-5 ml-2"></i> شاهد طريقة التحضير على يوتيوب</a>` : ''}
                            <div class="flex space-x-2 space-x-reverse mt-4">
                                <button id="add-suggested-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center">
                                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> إضافة هذه الوجبة للخطط
                                </button>
                                <button id="clear-suggested-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center">
                                    <i data-lucide="x-circle" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                        suggestedMealContainer.classList.remove('hidden');
                        lucide.createIcons();
                        showCustomNotification("تم اقتراح وجبة جديدة!");
                    } catch (e) {
                         showCustomNotification("حدث خطأ في تحليل استجابة الخادم.");
                    }
                } else {
                    showCustomNotification("لم يتمكن النظام من اقتراح وجبة حاليًا.");
                }

                isLoadingRecipe = false;
                toggleLoading(button, false, originalText);
            };

            const analyzeIngredients = async () => {
                if (isLoadingRecipe || isAnalyzingIngredients || isAnalyzingImage) return;

                const ingredients = suggestedMeal
                    ? suggestedMeal.ingredients.join(', ')
                    : userIngredientsInput.value.trim();
                
                if (!ingredients) {
                    showCustomNotification("الرجاء إدخال بعض المكونات أو اقتراح وجبة لتحليلها.");
                    return;
                }

                // New: Check API usage before proceeding
                const canProceed = await checkAndIncrementUsage();
                if (!canProceed) return;

                isAnalyzingIngredients = true;
                const button = analyzeIngredientsBtn;
                const originalText = button.querySelector('.button-text').textContent;
                toggleLoading(button, true, originalText);
                
                const preferencesText = dietaryPreferences.length > 0
                    ? `، مع الأخذ في الاعتبار التفضيلات الغذائية التالية: ${dietaryPreferences.map(p => {
                        switch(p) {
                            case 'vegetarian': return 'نباتي';
                            case 'vegan': return 'فيجن';
                            case 'gluten-free': return 'خالي من الغلوتين';
                            default: return '';
                        }
                    }).filter(Boolean).join(' و ')}`
                    : '';

                const prompt = `بناءً على المكونات التالية: "${ingredients}"${preferencesText}، قم بتقديم تحليل مختصر ومفيد. ركز على القيمة الغذائية الرئيسية واقترح بدائل بسيطة أو إضافات لتعزيز الفائدة. يجب أن تكون الإجابة على شكل نقاط (bullet points) فقط، لا تزيد عن 5 نقاط.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                const result = await callGeminiAPI(payload);

                if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    renderDynamicTips(analysisText);
                    showCustomNotification("تم تحليل المكونات بنجاح!");
                } else {
                    renderStaticTips();
                    showCustomNotification("لم يتمكن النظام من تحليل المكونات حاليًا.");
                }
                
                isAnalyzingIngredients = false;
                toggleLoading(button, false, originalText);
            };

            const analyzeImageIngredients = async (base64ImageData, mimeType) => {
                if (isLoadingRecipe || isAnalyzingIngredients || isAnalyzingImage) return;
                
                // New: Check API usage before proceeding
                const canProceed = await checkAndIncrementUsage();
                if (!canProceed) return;

                isAnalyzingImage = true;
                const button = imageSearchBtn;
                const originalText = button.querySelector('.button-text').textContent;
                toggleLoading(button, true, originalText, 'camera');

                const preferencesText = dietaryPreferences.length > 0
                    ? `، مع الأخذ في الاعتبار التفضيلات الغذائية التالية: ${dietaryPreferences.map(p => {
                        switch(p) {
                            case 'vegetarian': return 'نباتي';
                            case 'vegan': return 'فيجن';
                            case 'gluten-free': return 'خالي من الغلوتين';
                            default: return '';
                        }
                    }).filter(Boolean).join(' و ')}`
                    : '';

                const prompt = `ما هي المكونات الصالحة للطبخ التي تراها في هذه الصورة؟ اذكر فقط المكونات، وافصل بينها بفاصلة${preferencesText}.`;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ]
                };

                const result = await callGeminiAPI(payload);

                if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const ingredientsList = result.candidates[0].content.parts[0].text.trim();
                    userIngredientsInput.value = ingredientsList;
                    showCustomNotification("تم التعرف على المكونات بنجاح!");
                } else {
                    showCustomNotification("لم يتمكن النظام من التعرف على أي مكونات في الصورة.");
                }

                isAnalyzingImage = false;
                toggleLoading(button, false, originalText, 'camera');
            };
            
            // --- EVENT LISTENERS ---
            suggestFromIngredientsBtn.addEventListener('click', () => generateRecipe(false));
            suggestGeneralBtn.addEventListener('click', () => generateRecipe(true));
            analyzeIngredientsBtn.addEventListener('click', analyzeIngredients);
            themeToggleBtn.addEventListener('click', toggleDarkMode);
            toggleUserInfoBtn.addEventListener('click', toggleUserInfo);
            
            clearGroceryBtn.addEventListener('click', () => {
                mealPlans = [];
                renderMealPlans();
                saveUserData();
                showCustomNotification("تم مسح قائمة التسوق والوجبات المخططة.");
            });

            dietaryPreferenceCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    dietaryPreferences = Array.from(dietaryPreferenceCheckboxes)
                                                .filter(cb => cb.checked)
                                                .map(cb => cb.value);
                    saveUserData();
                });
            });

            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'add-suggested-btn' || e.target.closest('#add-suggested-btn')) {
                    addSuggestedMealToPlan();
                }
                if (e.target.id === 'clear-suggested-btn' || e.target.closest('#clear-suggested-btn')) {
                    clearSuggestedMeal();
                }
                if (e.target.classList.contains('delete-meal-btn') || e.target.closest('.delete-meal-btn')) {
                    const button = e.target.closest('.delete-meal-btn');
                    const mealId = parseInt(button.dataset.id, 10);
                    deleteMealPlan(mealId);
                }
                if (e.target.id === 'clear-analysis-btn' || e.target.closest('#clear-analysis-btn')) {
                    renderStaticTips();
                    showCustomNotification("تم مسح التحليل.");
                }
            });

            imageSearchBtn.addEventListener('click', () => {
                imageUploadInput.click();
            });

            imageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                         showCustomNotification('الرجاء اختيار ملف صورة صالح.');
                         return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Data = reader.result.split(',')[1];
                        analyzeImageIngredients(base64Data, file.type);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- INITIALIZATION ---
            renderStaticTips();
            renderMealPlans();
            renderUsageCount();
            lucide.createIcons();
        });
    </script>
</body>
</html>
